---
title: "[CLIENT NAME] AdWords Performance"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
# Libraries
library(RAdwords)
library(lubridate)
library(ggplot2)
library(tidyverse)
library(corrplot)
library(scales)
library(tidytext)
library(cowplot)
library(httr)
library(plotly)
library(AnomalyDetection)
library(gtrendsR)
library(treemap)

# Variables
googleAuth <- doAuth()
customerId <- Sys.getenv("CLIENT1ID")
availableBudget <- 30000
targetConversions <- 300

# Dates
yesterday = today() - days(1)
startOfCurrentMonth = today() - day(today()) + 1
endOfLastMonth = startOfCurrentMonth - 1 
starOfLastMonth = endOfLastMonth - days_in_month(endOfLastMonth) + 1
```
# Campaign performance
## Performance: Month-to-date

```{r campaign scatterplot 1, echo=FALSE, eval=FALSE}

chunk1_body <- statement(select=c('CampaignName','Conversions','CostPerConversion','Cost'),
                         report="CAMPAIGN_PERFORMANCE_REPORT",
                         where="Cost > 150000000",
                         start=startOfCurrentMonth,
                         end=yesterday)

chunk1_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk1_body)

names(chunk1_data) <- c("Campaign", "Conversions", "CPA", "Cost")

ggplot(chunk1_data, aes(x = Cost, y = CPA, size = Conversions)) +
    geom_point() +
    geom_text(aes(label = Campaign))

```

## Performance: Last 30 days

```{r campaign scatterplot 2, echo=FALSE, eval=FALSE}

thirtyDaysAgo <- today() - days(30)

chunk2_body <- statement(select=c('CampaignName','Conversions','CostPerConversion','Cost'),
                         report="CAMPAIGN_PERFORMANCE_REPORT",
                         where="Cost > 150000000",
                         start=thirtyDaysAgo,
                         end=yesterday)

chunk2_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk2_body)

names(chunk2_data) <- c("Campaign", "Conversions", "CPA", "Cost")

ggplot(chunk2_data, aes(x = Cost, y = CPA, size = Conversions)) +
    geom_point() +
    geom_text(aes(label = Campaign))

```

## Performance: Last 60 days

```{r campaign scatterplot 3, echo=FALSE, eval=FALSE}

sixtyDaysAgo <- today() - days(60)

chunk3_body <- statement(select=c('CampaignName','Conversions','CostPerConversion','Cost'),
                         report="CAMPAIGN_PERFORMANCE_REPORT",
                         where="Cost > 150000000",
                         start=sixtyDaysAgo,
                         end=yesterday)

chunk3_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk3_body)

names(chunk3_data) <- c("Campaign", "Conversions", "CPA", "Cost")

ggplot(chunk3_data, aes(x = Cost, y = CPA, size = Conversions)) +
    geom_point() +
    geom_text(aes(label = Campaign))

```

## Performance: Last 90 days

```{r campaign scatterplot 4, echo=FALSE, eval=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk4_body <- statement(select=c('CampaignName','Conversions','CostPerConversion','Cost'),
                         report="CAMPAIGN_PERFORMANCE_REPORT",
                         where="Cost > 150000000",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk4_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk4_body)

names(chunk4_data) <- c("Campaign", "Conversions", "CPA", "Cost")

 ggplot(chunk4_data, aes(x = Cost, y = CPA, size = Conversions)) +
    geom_point() +
    geom_text(aes(label = Campaign))

```

# Metrics correlation plot

```{r correlation plot, echo=FALSE, eval=FALSE}

aYearAgo <- today() - days(365)

chunk5_body <- statement(select=c('Date','Clicks','Conversions','CostPerConversion',
                                  'Cost','ConversionRate','AverageCpc','Impressions','Ctr'),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=aYearAgo,
                         end=yesterday)

chunk5_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk5_body)

corr <- cor(chunk5_data[,-1])

corrplot(corr, method = "pie", type = "upper")

```		
# Ad Scheduling Heatmaps

## Ad Scheduling: Impressions

```{r ad scheduling heatmap 1, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk6_body <- statement(select=c("DayOfWeek","HourOfDay","Impressions","Conversions","CostPerConversion","SearchImpressionShare"),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk6_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk6_body)

names(chunk6_data) <- c("DayOfWeek", "HourOfDay", "Impressions", "Conversions","CPA","SearchIS")

chunk6_data$HourOfDay <- factor(chunk6_data$HourOfDay, levels=c(0:23))
chunk6_data$DayOfWeek <- factor(chunk6_data$DayOfWeek, levels=c("Sunday","Saturday","Friday","Thursday","Wednesday","Tuesday","Monday"))

ggplot(chunk6_data, aes(x=HourOfDay, y=DayOfWeek, z=Impressions)) + geom_tile(aes(fill = Impressions)) +
    scale_fill_gradient(low="white", high="blue", labels=comma)

```

## Ad Scheduling: Search Impression Share

```{r ad scheduling heatmap 2, echo=FALSE, eval=FALSE}

ggplot(chunk6_data, aes(x=HourOfDay, y=DayOfWeek, z=SearchIS)) + geom_tile(aes(fill = SearchIS)) +
    scale_fill_gradient2(low="white", high="blue", labels=comma, midpoint=0.5)

```

## Ad Scheduling: Conversions

```{r ad scheduling heatmap 3, echo=FALSE, eval=FALSE}

ggplot(chunk6_data, aes(x=HourOfDay, y=DayOfWeek, z=Conversions)) + geom_tile(aes(fill = Conversions)) +
    scale_fill_gradient(low="white", high="blue", labels=comma)

```

## Ad Scheduling: CPA

```{r ad scheduling heatmap 4, echo=FALSE, eval=FALSE}

ggplot(chunk6_data[chunk6_data$CPA > 0,], aes(x=HourOfDay, y=DayOfWeek, z=CPA)) + geom_tile(aes(fill = CPA)) +
    scale_fill_gradient2(low="white", high="blue", labels=comma, midpoint=50)

```

# Search Terms N-Grams

```{r tidy search terms, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)
data(stop_words)

chunk7_body <- statement(select=c("Query","Clicks","Impressions","Conversions","Cost"),
                         report="SEARCH_QUERY_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk7_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk7_body)

unigrams <- chunk7_data %>% unnest_tokens(word, Searchterm) %>% anti_join(stop_words) %>%
    group_by(word) %>%
    summarize(Clicks=sum(Clicks), Impressions=sum(Impressions), Conversions=sum(Conversions), Cost=sum(Cost),
              Ctr=sum(Clicks)/sum(Impressions), ConversionRate=sum(Conversions)/sum(Clicks), Cpa=sum(Cost)/sum(Conversions),
              AvgCpc = sum(Cost)/sum(Clicks))

bigrams <- chunk7_data %>% unnest_tokens(bigram, Searchterm, token="ngrams", n=2) %>% group_by(bigram) %>%
    summarize(Clicks=sum(Clicks), Impressions=sum(Impressions), Conversions=sum(Conversions),
              Cost=sum(Cost), Ctr=sum(Clicks)/sum(Impressions), ConversionRate=sum(Conversions)/sum(Clicks),
              Cpa=sum(Cost)/sum(Conversions), AvgCpc = sum(Cost)/sum(Clicks))

trigrams <- chunk7_data %>% unnest_tokens(trigram, Searchterm, token="ngrams", n=3) %>% group_by(trigram) %>%
    summarize(Clicks=sum(Clicks), Impressions=sum(Impressions), Conversions=sum(Conversions),
              Cost=sum(Cost), Ctr=sum(Clicks)/sum(Impressions), ConversionRate=sum(Conversions)/sum(Clicks),
              Cpa=sum(Cost)/sum(Conversions), AvgCpc = sum(Cost)/sum(Clicks))

```

## Unigrams

```{r unigrams, echo=FALSE, eval=FALSE}

pu_imp <- unigrams %>% top_n(10, Impressions) %>% ggplot(aes(y=Impressions, x=reorder(word, Impressions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_clicks <- unigrams %>% top_n(10, Clicks) %>% ggplot(aes(y=Clicks, x=reorder(word, Clicks))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_ctr <- unigrams %>% filter(Clicks > 100) %>% top_n(10, Ctr) %>% ggplot(aes(y=Ctr, x=reorder(word, Ctr))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_cpc <- unigrams %>% filter(Clicks > 100) %>% top_n(10, AvgCpc) %>% ggplot(aes(y=AvgCpc, x=reorder(word, AvgCpc))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_cost <- unigrams %>% top_n(10, Cost) %>% ggplot(aes(y=Cost, x=reorder(word, Cost))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_conv <- unigrams %>% top_n(10, Conversions) %>% ggplot(aes(y=Conversions, x=reorder(word, Conversions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_cpa <- unigrams %>% filter(Conversions > 1) %>% top_n(10, Cpa) %>% ggplot(aes(y=Cpa, x=reorder(word, Cpa))) +
    geom_bar(stat = "identity") +
    coord_flip()

pu_cr <- unigrams %>% filter(Conversions > 1) %>% top_n(10, ConversionRate) %>% ggplot(aes(y=ConversionRate, x=reorder(word, ConversionRate))) +
    geom_bar(stat = "identity") +
    coord_flip()

plot_grid(pu_imp, pu_clicks, pu_ctr, pu_cpc, pu_cost, pu_conv, pu_cpa, pu_cr, ncol=2)

```

## Bigrams

```{r bigrams, echo=FALSE, eval=FALSE}

pb_imp <- bigrams %>% top_n(10, Impressions) %>% ggplot(aes(y=Impressions, x=reorder(bigram, Impressions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_clicks <- bigrams %>% top_n(10, Clicks) %>% ggplot(aes(y=Clicks, x=reorder(bigram, Clicks))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_ctr <- bigrams %>% filter(Clicks > 100) %>% top_n(10, Ctr) %>% ggplot(aes(y=Ctr, x=reorder(bigram, Ctr))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_cpc <- bigrams %>% filter(Clicks > 100) %>% top_n(10, AvgCpc) %>% ggplot(aes(y=AvgCpc, x=reorder(bigram, AvgCpc))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_cost <- bigrams %>% top_n(10, Cost) %>% ggplot(aes(y=Cost, x=reorder(bigram, Cost))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_conv <- bigrams %>% top_n(10, Conversions) %>% ggplot(aes(y=Conversions, x=reorder(bigram, Conversions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_cpa <- bigrams %>% filter(Conversions > 1) %>% top_n(10, Cpa) %>% ggplot(aes(y=Cpa, x=reorder(bigram, Cpa))) +
    geom_bar(stat = "identity") +
    coord_flip()

pb_cr <- bigrams %>% filter(Conversions > 1) %>% top_n(10, ConversionRate) %>% ggplot(aes(y=ConversionRate, x=reorder(bigram, ConversionRate))) +
    geom_bar(stat = "identity") +
    coord_flip()

plot_grid(pb_imp, pb_clicks, pb_ctr, pb_cpc, pb_cost, pb_conv, pb_cpa, pb_cr, ncol=2)

```

## Trigrams

```{r trigrams, echo=FALSE, eval=FALSE}

pt_imp <- trigrams %>% top_n(10, Impressions) %>% ggplot(aes(y=Impressions, x=reorder(trigram, Impressions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_clicks <- trigrams %>% top_n(10, Clicks) %>% ggplot(aes(y=Clicks, x=reorder(trigram, Clicks))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_ctr <- trigrams %>% filter(Clicks > 100) %>% top_n(10, Ctr) %>% ggplot(aes(y=Ctr, x=reorder(trigram, Ctr))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_cpc <- trigrams %>% filter(Clicks > 100) %>% top_n(10, AvgCpc) %>% ggplot(aes(y=AvgCpc, x=reorder(trigram, AvgCpc))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_cost <- trigrams %>% top_n(10, Cost) %>% ggplot(aes(y=Cost, x=reorder(trigram, Cost))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_conv <- trigrams %>% top_n(10, Conversions) %>% ggplot(aes(y=Conversions, x=reorder(trigram, Conversions))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_cpa <- trigrams %>% filter(Conversions > 1) %>% top_n(10, Cpa) %>% ggplot(aes(y=Cpa, x=reorder(trigram, Cpa))) +
    geom_bar(stat = "identity") +
    coord_flip()

pt_cr <- trigrams %>% filter(Conversions > 1) %>% top_n(10, ConversionRate) %>% ggplot(aes(y=ConversionRate, x=reorder(trigram, ConversionRate))) +
    geom_bar(stat = "identity") +
    coord_flip()

plot_grid(pt_imp, pt_clicks, pt_ctr, pt_cpc, pt_cost, pt_conv, pt_cpa, pt_cr, ncol=2)

```

# Impression Share analysis

```{r impression share, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk8_body <- statement(select=c("Date","AverageCpc","SearchRankLostImpressionShare","SearchBudgetLostImpressionShare",
                                  "SearchExactMatchImpressionShare","SearchImpressionShare"),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk8_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk8_body)

names(chunk8_data) <- c("Day","CPC","ISLostToRank","ISLostToBudget","ExactMatchIS","IS")

long_chunk8 <- gather(chunk8_data, metric, value, CPC:IS)

long_IS <- long_chunk8 %>% filter(metric %in% c("IS","ISLostToBudget","ISLostToRank"))
long_other <- long_chunk8 %>% filter(metric %in% c("CPC","ExactMatchIS"))

ggplot(long_other, aes(x = Day, y = value)) +
    geom_line() +
    facet_wrap(~metric, ncol=1)

ggplot(long_IS) +
    geom_area(aes(x = Day, y = value, fill = metric), position = "stack")

```

# Metrics pacing vs targets

```{r metrics pacing, echo=FALSE, eval=FALSE}

chunk9_body <- statement(select=c('Conversions','Cost'),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=startOfCurrentMonth,
                         end=yesterday)

chunk9_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk9_body)

paceConv <- (targetConversions/days_in_month(today())) * day(yesterday)
paceCost <- (availableBudget/days_in_month(today())) * day(yesterday)

allStats <- data.frame(stat = c("target","pace","current"),
                       conversions = c(targetConversions, paceConv, chunk9_data$Conversions),
                       cost = c(availableBudget, paceCost, chunk9_data$Cost))

ggplot(data = allStats, aes(x = "", y = conversions, fill = stat)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.2) +
    coord_flip()

ggplot(data = allStats, aes(x = "", y = cost, fill = stat)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.2) +
    coord_flip()

```

# Device performance

```{r device performance, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk10_body <- statement(select=c('Date','Device','Conversions','CostPerConversion',
                                  'ConversionRate','AverageCpc','Impressions','Ctr'),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk10_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk10_body)

long_chunk10 <- chunk10_data %>% gather(metric, value, Conversions:CTR)

long_chunk10 %>% ggplot(aes(x = Day, y = value, color = Device)) +
    geom_line() +
    facet_grid(metric ~ ., scales = "free_y")

```

# 404 Checker

```{r 404 checker, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk11_body <- statement(select=c('EffectiveFinalUrl'),
                         report="FINAL_URL_REPORT",
                         where="Impressions > 0",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk11_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk11_body)

responseCodes <- character()

for(i in chunk11_data$FinalURL){
    url <- as.character(i)
    response <- GET(i)
    Sys.sleep(sample(1:5, 1))
    responseCodes <- c(responseCodes, response$status_code)
}

responseCodes <- data.frame(ResponseCode = responseCodes)

problemURLs <- cbind(chunk11_data, responseCodes) %>% filter(responseCodes != 200)

if(nrow(problemURLs) == 0){
    message("All Final URLs are ok.")
}else{ problemURLs }

```

# Quality Score analysis

```{r quality score analysis, echo=FALSE, eval=FALSE}

chunk12_body <- statement(select=c("Date","CampaignName","AdGroupName","Criteria","Impressions","HasQualityScore","CreativeQualityScore",
                                   "PostClickQualityScore","SearchPredictedCtr","QualityScore"),
                         report="KEYWORDS_PERFORMANCE_REPORT",
                         where="HasQualityScore = TRUE",
                         start=yesterday,
                         end=yesterday)

chunk12_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk12_body)

chunk12_data %>% group_by(Adrelevance) %>% summarize(n = n()) %>% mutate(freq = n/sum(n)) %>% arrange(desc(n))
chunk12_data %>% group_by(Landingpageexperience) %>% summarize(n = n()) %>% mutate(freq = n/sum(n)) %>% arrange(desc(n))
chunk12_data %>% group_by(Expectedclickthroughrate) %>% summarize(n = n()) %>% mutate(freq = n/sum(n)) %>% arrange(desc(n))
chunk12_data %>% group_by(Qualityscore) %>% summarize(n = n()) %>% mutate(freq = n/sum(n)) %>% arrange(desc(n))

plot_data <- chunk12_data %>% mutate(QSImpr = as.numeric(Qualityscore) * Impressions) %>% group_by(Campaign, Adgroup) %>%
    summarise(QSImpr = sum(QSImpr), Impressions = sum(Impressions)) %>% ungroup() %>% mutate(weightedQS = QSImpr/Impressions) 

plot <- plot_data %>% ggplot(aes(x = weightedQS, y = 1)) + geom_text(aes(label = Adgroup),position = position_jitter(0.7), size = 1.5)
ggplotly(plot)

```

# Match type performance

```{r match type performance, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk13_body <- statement(select=c("Date","KeywordMatchType","Impressions","Clicks","Cost","Conversions"),
                         report="KEYWORDS_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk13_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk13_body)
names(chunk13_data) <- c("Date","MatchType","Impressions","Clicks","Cost","Conversions")

chunk13_data <- chunk13_data %>% group_by(Date, MatchType) %>%
    summarize(Impressions = sum(Impressions), Clicks = sum(Clicks), Cost = sum(Cost),Conversions = sum(Conversions)) %>%
    mutate(Ctr = Clicks/Impressions, CPC = Cost/Clicks, CPA = Cost/Conversions, ConversionRate = Conversions/Clicks)

chunk13_long <- gather(chunk13_data, metric, value, Impressions:ConversionRate)

ggplot(chunk13_long, aes(y = value, x = Date, color = MatchType)) +
    geom_line() +
    facet_grid(metric ~ ., scales = "free_y")

```

# Ad/Keyword Performance

```{r adKeywords performance, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk14_body <- statement(select=c('CampaignName','AdGroupName','Id','Description','HeadlinePart2','CriterionId',
                                   'Cost',"Conversions","CostPerConversion"),
                         report="AD_PERFORMANCE_REPORT",
                         where="Cost > 100000000 AND AdNetworkType1 = SEARCH",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk14_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk14_body)

names(chunk14_data) <- c("Campaign", "AdGroup", "AdId", "Description", "Headline2", "KeywordId",
                         "Cost", "Conversions", "CPA")

plot_ly(data = chunk14_data, x = ~Cost, y = ~CPA, size = ~Conversions,
            text = ~paste("Campaign: ", Campaign, "<br>AdGroup: ", AdGroup, "<br>Headline2: ",
                            Headline2, "<br>Description: ", Description ,"<br>KeywordId: ", KeywordId))

```

# 3x3 Performance Segments

```{r performance segments matrix, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk15_body <- statement(select=c("Criteria","CostPerConversion","Impressions","QualityScore",
                                   "Cost","Conversions", "AveragePosition", "AverageCpc"),
                         report="KEYWORDS_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk15_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk15_body)
names(chunk15_data) <- c("Keyword","CPA","Impressions","QS","Cost","Conversions","Position","CPC")
```

## Converters

```{r converters matrix, echo=FALSE, eval=FALSE}

hasConversions <- chunk15_data %>% filter(Conversions > 0)

plot_ly(data = hasConversions, x = ~log(Conversions), y = ~CPA, color = ~Position, size = ~Position,
        text = ~paste("Keyword: ", Keyword, "<br>Conversions: ", Conversions,
                      "<br>CPA: ", CPA, "<br>Position: ", Position))
```

## Non-converters

```{r non-converters matrix, echo=FALSE, eval=FALSE}

notConverting <- chunk15_data %>% filter(Conversions == 0, Cost > 0)

plot_ly(data = notConverting, x = ~log(Cost), y = ~CPC, color = ~Position, size = ~Position,
        text = ~paste("Keyword: ", Keyword, "<br>Cost: ", Cost,
                      "<br>CPC: ", CPC, "<br>Position: ", Position))
```

## Clickless

```{r clickless matrix, echo=FALSE, eval=FALSE}

clickless <- chunk15_data %>% filter(Cost == 0, Impressions > 0)

plot_ly(data = clickless, x = ~log(Impressions), y = ~QS, color = ~Position, size = ~Position, type = 'scatter',
        text = ~paste("Keyword: ", Keyword, "<br>Impressions: ", Impressions,
                      "<br>QS: ", QS, "<br>Position: ", Position))
```

# Anomaly detection

```{r anomaly detection, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk16_body <- statement(select=c("Date","HourOfDay","Clicks","Conversions","CostPerConversion",
                                   "AverageCpc","SearchImpressionShare", "AveragePosition"),
                         report="ACCOUNT_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk16_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk16_body)

names(chunk16_data) <- c("Date","HourOfDay","Clicks","Conversions","CPA","CPC","SearchIS","Position")
anomalyData <- chunk16_data %>% mutate(DateTime = ymd_hms(paste0(Date," ",HourOfDay,":00:00")))
anomalyData <- anomalyData %>% arrange(DateTime)

anomClicks <- AnomalyDetectionTs(anomalyData[,c("DateTime","Clicks")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "Clicks")
anomClicks$plot

anomConversions <- AnomalyDetectionTs(anomalyData[,c("DateTime","Conversions")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "Conversions")
anomConversions$plot

anomCPA <- AnomalyDetectionTs(anomalyData[,c("DateTime","CPA")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "CPA")
anomCPA$plot

anomCPC <- AnomalyDetectionTs(anomalyData[,c("DateTime","CPC")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "CPC")
anomCPC$plot

anomSearchIS <- AnomalyDetectionTs(anomalyData[,c("DateTime","SearchIS")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "SearchIS")
anomSearchIS$plot

anomPosition <- AnomalyDetectionTs(anomalyData[,c("DateTime","Position")], direction='both',
                                 plot=TRUE, e_value=TRUE, max_anoms=0.01, ylabel = "Position")
anomPosition$plot

```

# Google Trends: Top 5 keywords

```{r google trends, echo=FALSE, eval = FALSE}

ninetyDaysAgo <- today() - days(90)

chunk17_body <- statement(select=c("Criteria","Impressions","SearchImpressionShare"),
                         report="KEYWORDS_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk17_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk17_body)
names(chunk17_data) <- c("Keyword","Impressions","SearchIS")

lookupTerms <- chunk17_data %>% mutate(impVolume = Impressions / SearchIS) %>%
    arrange(desc(impVolume)) %>% head(5) %>% select(Keyword)

res <- gtrends(str_replace_all(lookupTerms[,1], "\\+",""), geo = "IE")
plot(res)

```

# Treemaps

```{r treemaps, echo=FALSE, eval=FALSE}

ninetyDaysAgo <- today() - days(90)

chunk18_body <- statement(select=c("CampaignName","Cost","CostPerConversion"),
                         report="CAMPAIGN_PERFORMANCE_REPORT",
                         start=ninetyDaysAgo,
                         end=yesterday)

chunk18_data <- getData(clientCustomerId=customerId, google_auth=googleAuth, statement=chunk18_body)
names(chunk18_data) <- c("Campaign","Cost","CPA")

treemap(chunk18_data, 
        index="Campaign",  
        vSize = "Cost",  
        vColor = "CPA",
        type="value")

```
